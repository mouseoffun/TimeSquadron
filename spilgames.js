(function(t){"use strict";function e(t,e,i){this.isMaster=t,this.messenger=e,this.moduleReady=i?i:!1,this.timeoutAfter=500,this.timeout=!1,this._callbacks={pause:!1,resume:!1},this._setupEvents()}function i(t,e,i){this.data=t,this.messenger=e,this.moduleReady=i?i:!1,this.gamePlayTracking={started:!1,appid:null,host:null,timestamp:null},this.timeInGameTracking={started:!1,appid:null,timestamp:null};var a=t&&t.game&&t.game.applicationId?t.game.applicationId:0,s=new Date,n=window.location.hostname;this.startInternalTracking(a,s,n)}function a(t,e){this.data=t,this.moduleReady=e?e:!1}function s(t){var e="string"==typeof t?n(t):t;if(!e)throw Error("Could not create a message from input");this.type=e.type,this.callbackId=e.callbackId,this.data=e.data}function n(t){var e,i,a,s=!1,n=[];if("string"==typeof t&&(n=t.split("|"),"gameapi"===n[0])){n.shift(),e=n.shift(),a=parseInt(n.shift(),10),i=n.join("|");try{s={type:e,callbackId:a,data:""!==i?JSON.parse(i):""}}catch(r){}}return s}function r(t,e){this.IS_MASTER="boolean"==typeof t?t:!1,this.IS_SLAVE=!this.IS_MASTER,this._target=e||window.parent,this._callbacks=[],this._channels=[],this._setupEventListener()}function o(){this.version="0.2.0",this.config={SPAPI:"//api.spilgames.com/"},this.isReady=!1}var c={};c.argsToArray=function(t){return t?Array.prototype.slice.apply(t):[]},c.getRole=function(){var t="function"==typeof window.SpilGames&&window.SpilGamesBootstrap instanceof Array;return t?"master":"slave"},c.isArray=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},c.getEnvData=function(){},c.getGameData=function(){},c.getUserData=function(){},e.prototype._setupEvents=function(){var t=this.messenger;this.isMaster?(this.messenger.subscribe("game.ad.request",this._triggerAd),SpilGames(["JSLib"],function(e){e.subscribe("ad.request.accepted",function(e){!0===e&&(SpilGames("game.ad.accepted",!0),t._postMessage(!0,void 0,"ad.request.accepted"))}),e.subscribe("ad.complete",function(){t._postMessage(void 0,void 0,"ad.complete")})})):(this.messenger.subscribe("ad.request.accepted",this._onAdAccepted,this),this.messenger.subscribe("ad.complete",this._onAdCompleted,this))},e.prototype._triggerAd=function(){SpilGames("game.ad.request")},e.prototype._runCallback=function(t){this._callbacks[t]&&(this._callbacks[t](),this._callbacks[t]=!1)},e.prototype.request=function(t,e){var i=this;if("function"!=typeof t)throw Error("pauseGame argument should be a function");if("function"!=typeof e)throw Error("resumeGame argument should be a function");if(!this.moduleReady)throw Error("This method cannot be called before the API is loaded");this._callbacks.pause=t,this._callbacks.resume=e,this.messenger._postMessage(void 0,void 0,"game.ad.request"),this.timeout=setTimeout(function(){i._requestTimeout()},this.timeoutAfter)},e.prototype._onAdAccepted=function(t){this.timeout&&clearTimeout(this.timeout),!this.isMaster&&t&&this._runCallback("pause")},e.prototype._onAdCompleted=function(){this.isMaster||this._runCallback("resume")},e.prototype._requestTimeout=function(){this._onAdCompleted()},i.prototype._createEventObject=function(t,e,i){return{eventCategory:t,eventAction:e,properties:i}},i.prototype._sendSETEvent=function(t,e,i){return this.messenger&&this.messenger.post("tracker.event."+t,e,i),e},i.prototype.trackGamePlay=function(t){if(!this.gamePlayTracking.started)return!1;var e=this.gamePlayTracking.gid,i=this.gamePlayTracking.timestamp,a=this.gamePlayTracking.host,s=this._createEventObject("game","gameplay",{applicationId:e,start:i,host:a});return this._sendSETEvent("express",s,t),s},i.prototype.trackTimeInGame=function(t){if(!this.timeInGameTracking.started)return!1;var e=this.timeInGameTracking.gid,i=this.timeInGameTracking.timestamp,a=this._createEventObject("game","heartbeat",{applicationId:e,start:i});return this._sendSETEvent("express",a,t),a},i.prototype.startInternalTracking=function(t,e,i){return this.moduleReady?(this.gamePlayTracking.gid=t,this.gamePlayTracking.timestamp=Date.parse(e),this.gamePlayTracking.host=i,this.gamePlayTracking.started=!0,this.timeInGameTracking.gid=t,this.timeInGameTracking.timestamp=Date.parse(e),this.timeInGameTracking.started=!0,this.trackGamePlay(function(t){if(!t)throw"Could not save the game play"}),this.trackTimeInGame(function(t){if(!t)throw"Could not save the time in game"}),this.gamePlayTracking.started&&this.timeInGameTracking.started):{error:"This method cannot be called before the API is loaded"}},a.prototype.getLogo=function(t){function e(t){for(var e in t)if(t.hasOwnProperty(e)){if(!a.hasOwnProperty(e))return{error:"Wrong argument passed: "+e};if(a.hasOwnProperty(e)&&t[e].constructor.name!==a[e])return{error:"Wrong value type for "+e+": expected "+a[e]+", got "+t[e].constructor.name}}return{error:!1}}function i(t){var e=s;for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e}if(!this.moduleReady)return{error:"This method cannot be called before the API is loaded"};var a={position:"String",posX:"Number",posY:"Number",maxHeight:"Number",maxWidth:"Number"},s={image:"http://cdn.gameplayer.io/wdg/gameapi-active/img/zibbo-logo.png",link:"http://zibbo.com/?utm_content=logo&utm_source=unknown",posX:10,posY:20,scale:1};if(t&&"object"==typeof t){var n=s,r=e(t);return r.error?n.error=r.error:n=i(t),n}return s},s.prototype.encode=function(){var t=["gameapi",this.type,this.callbackId,this.data?JSON.stringify(this.data):""].join("|");return t},r.prototype._postMessage=function(t,e,i){var a,n;a=c.isArray(t)&&"function"==typeof t[t.length-1]?this._callbacks.push(t.pop())-1:e,n=new s({type:i||"jslib",callbackId:a,data:t}).encode(),this._target.postMessage(n,"*")},r.prototype._callJSLib=function(){SpilGames.apply(SpilGames,c.argsToArray(arguments))},r.prototype._setupEventListener=function(){function t(t){e._handleMessage(t)}var e=this;window.addEventListener?window.addEventListener("message",t,!1):window.attachEvent&&window.attachEvent("onmessage",t)},r.prototype._handleMessage=function(t){var e,i,a,n,r=this,o=new s(t.data);return o&&(e=o.type,i=o.callbackId,a=o.data,n=this._callbacks[i]||!1,this.IS_MASTER?"jslib"===e?(a.push(function(t){r._postMessage(t,i)}),this._callJSLib.apply(this,a)):this.publish(e,a):this.IS_SLAVE&&("function"==typeof n?(delete this._callbacks[i],n(a)):"jslib"!==e&&this.publish(e,a))),!1},r.prototype.post=function(){var t=c.argsToArray(arguments);return this.IS_SLAVE?this._postMessage(t):this._callJSLib.apply(this,t),this},r.prototype.publish=function(t,e){return this._channels[t]&&this._channels[t].forEach(function(t){try{t.fn.call(t.ctx,e)}catch(i){}}),this},r.prototype.subscribe=function(t,e,i){if("function"!=typeof e)throw Error("Callback has to be a function");if("string"!=typeof t)throw Error("Channel name has to be a string");return this._channels[t]||(this._channels[t]=[]),this._channels[t].push({fn:e,ctx:i}),this},r.prototype.unsubscribe=function(t,e){return this._channels[t]&&"function"==typeof e&&(this._channels[t]=this._channels[t].filter(function(t){return t.fn!==e})),this},r.prototype.subscribeOnce=function(t,e,i){function a(i){s.unsubscribe(t,a),e.call(this,i)}var s=this;return this.subscribe(t,a,i)},o.prototype.loadAPI=function(t){var s,n,o=c.getRole(),h={user:{},game:{},env:{}},u=window.parent;return this.IS_MASTER="master"===o,this.IS_SLAVE=!this.IS_MASTER,this.IS_MASTER&&(s=document.getElementById("iframegame"),u=s&&s.contentWindow,h.user=c.getUserData(),h.game=c.getGameData(),h.env=c.getEnvData()),n=new r(this.IS_MASTER,u),this.Branding=new a(h,!0),this.EventTracking=new i(h,n,!0),this.GameBreak=new e(this.IS_MASTER,n,!0),this.isReady=!0,t.call(this,this)},"function"==typeof define&&define.amd&&define(new o),t.GameAPI=new o})(window);
//# sourceMappingURL=gameapi.min.js.map